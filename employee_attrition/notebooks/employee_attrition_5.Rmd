---
title: "Predicting Employee Turnover"
author: "Deepak Kumar G S"
date: "December 1, 2017"
output: 
  html_document:
    toc: TRUE
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE,message=FALSE)
```

# Introduction :

* We have been provided with the HR employee attrition data and build a model to predict the attrition.

* Further,we will combine both the models and check whether the ensemble model performance outperforms the individual models.

**If you like my kernel,pls upvote and encourage**

# Loading required libraries and dataset:

```{r}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(corrplot)
library(forcats)
library(gridExtra)
library(stringr)
library(caret)
library(formattable)
library(rpart)
library(rpart.plot)
#library(Deducer)
library(Boruta)
library(DMwR)
library(ROCR)
library(dummy)
library(neuralnet)
library(caretEnsemble)
library(h2o)
attr=read.csv("../input/WA_Fn-UseC_-HR-Employee-Attrition.csv",header=TRUE,stringsAsFactors = FALSE)
#dim(attr)
summary(attr)
```

* From the broad overview of the dataset,we understand that there are 2940 observations with 35 variables.There are no **NA** values in the dataset.
*From this overview we find that columns like over18,employeecount,standardhours are not informative and remove it.

```{r}
cat("No of Columns before removing:",ncol(attr),sep="\n")
attr=attr[,!(names(attr) %in% c('Over18','EmployeeCount','StandardHours','EmployeeNumber'))]
cat("No of Columns before removing:",ncol(attr),sep="\n")
```


Let us check the attrition percentage of the organisation.

```{r}
round((prop.table(table(attr$Attrition)))*100,2)
```

The dataset is imbalanced with 83 % of the representation from no attrition and only 16 % is represented by attrition group.Therefore a baseline prediction would predict all the respondents as no attrition.


# Exploratory Data Analysis:

Before modelling,we need to find out the variables that could be important in predicting the outcome.Therefore we do some univariate and bivariate data analysis to discover insights and try to correlate the datas.


##Correlation Plot:

```{r,fig.height=7,fig.width=7}
numeric=attr %>% dplyr::select(Age,DailyRate,DistanceFromHome,HourlyRate,MonthlyIncome,MonthlyRate,NumCompaniesWorked,PercentSalaryHike,YearsAtCompany,YearsInCurrentRole,YearsSinceLastPromotion,YearsWithCurrManager,TotalWorkingYears,TrainingTimesLastYear,StockOptionLevel)
corrplot(cor(numeric),method="circle",type="upper")

```


* From the correlation plot,we see that the predictor variables are less correlated to each other.The variables years at company,years in currentrole,years since last promotion,years with current manager,total working years each have negative correlation.



## Distribution of Age


```{r}
ggplot(attr,aes(Age))+geom_histogram(binwidth=5,aes(y=..count..),fill="green4")+theme_few()+theme(legend.position="none",plot.title = element_text(hjust=0.5,size=15))+labs(x="Age",y="Count",title="Distribution of Age")
```

From the plot,we understand that median age is between 30 to 40 years and maximum is 60 years.Let us correlate this with the attrition levels.

```{r}
attr %>% filter(Attrition == "Yes") %>% ggplot(aes(Age))+geom_histogram(binwidth=5,aes(y=round(((..count..)/sum(..count..))*100,2)),fill="red")+theme_few()+theme(legend.position="none",plot.title = element_text(hjust=0.5,size=15))+labs(x="Age",y="Percentage",title="Age distribution of people who leave")+scale_y_continuous(limits=c(0,30),breaks=seq(0,30,5))+scale_x_continuous(limits=c(15,60),breaks=seq(15,60,5))
```

* Almost ,30 % of the people who leave are about 30 years and a significant percentage fall below 40 years of age.


```{r}
attr %>% filter(Attrition == "No") %>% ggplot(aes(Age))+geom_histogram(binwidth=5,aes(y=round(((..count..)/sum(..count..))*100,2)),fill="green4")+theme_few()+theme(legend.position="none",plot.title = element_text(hjust=0.5,size=15))+labs(x="Age",y="Percentage",title="Age distribution of people who Stay")+scale_y_continuous(limits=c(0,30),breaks=seq(0,30,5))+scale_x_continuous(limits=c(15,60),breaks=seq(15,60,5))
```

* A significant % of people who do not leave the company are of age 35 to 40 years as described by the plot.



Let us check the salary difference among males and females.

```{r}
ggplot(attr,aes(Gender,MonthlyIncome,fill=Gender))+geom_boxplot()+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=10))+labs(x="Gender",y="Salary",title="Salary with Gender")+scale_fill_canva(palette="Neon and bold")+coord_flip()
```


## Attrition Vs Marital Status:

Let us check whether there is a relationship between attrition levels and marital status.

```{r}
ggplot(attr,aes(MaritalStatus,..count..,fill=Attrition))+geom_bar(position=position_dodge())+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16))+labs(title="Attrition Count Vs Marital Status")
```

From the plot,it is understood that irrespective of the marital status,there are large people who stay with the company and do not leave.Therefore,marital status is a weak predictor of attrition.

Let us include age and  monthly income too and do the analysis.

```{r}
ggplot(attr,aes(Age,MonthlyIncome,size=Age,col=factor(Attrition)))+geom_point(alpha=0.3)+theme_minimal()+facet_wrap(~MaritalStatus)+labs(x="Age",y="MonthlyIncome",title="Attrition Level Comparision ",subtitle="How attrition is observed with change in Age,Income and MaritalStatus",col="Attrition")+theme(legend.position="bottom",plot.title=element_text(size=16,hjust=0.5),plot.subtitle = element_text(size=10))+scale_color_brewer(palette="Set2")

```


* The trend is linear for age and monthly income across the marital status.
* It is observed that attrition is more pronounced with "single" people across the age groups.
* Married people having lower salary attrit more whereas divorced people have not attrited much.

## Attrition Vs Department:

The amount of work and stress levels obviously depends on the department a person works in.Therefore we assume that this could be a good indicator of attrition levels.Let us check.

```{r,fig.width=10,fig.height=7}
cat("There are",length(unique(attr$Department)),"unique departments in the dataset")
ggplot(attr,aes(x=Department,group=Attrition))+geom_bar(aes(y=..prop..,fill=factor(..x..)),stat="count")+facet_grid(~Attrition)+theme(axis.text.x=element_text(angle=90,vjust=0.5),legend.position="none",plot.title=element_text(size=16,hjust=0.5))+labs(x="Department",y="Percentage",title="Attrition  % Vs Department")+ geom_text(aes(label = scales::percent(..prop..), y = ..prop.. ),stat= "count",vjust =-.5) +scale_x_discrete(labels=function(x) str_wrap(x,width=10))+scale_fill_brewer(palette="Set2")
```

* On comparing departmentwise,we can conclude that HR has seen only a marginal high in turnover rates whereas the numbers are significant in sales department with turnover rates of 39 %. The attrition levels are not appreciable in R & D where 67 % have recorded no attrition.

* Let us also check the attrition levels departmentwise.

```{r}
ggplot(attr,aes(x=Attrition,group=Department))+geom_bar(aes(y=..prop..,fill=factor(..x..)),stat="count")+facet_grid(~Department)+theme(axis.text.x=element_text(angle=90,vjust=0.5),legend.position="none",plot.title=element_text(size=16,hjust=0.5))+labs(x="Attrition",y="Percentage",title="Department Vs Attrition %")+ geom_text(aes(label = scales::percent(..prop..), y = ..prop.. ),stat= "count",vjust =-.5) +scale_x_discrete(labels=function(x) str_wrap(x,width=10))+scale_fill_brewer(palette="Set3")

```


* Sales has seen higher attrition levels (about 20.6%) followed by HR(19%).

## Attrition Vs Distance From Home:

```{r}
ggplot(attr,aes(DistanceFromHome,fill=Attrition))+geom_density(alpha=0.5)+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16))+labs(x="Distance from Home",title="Attrition Vs Distance From Home")+scale_fill_canva(palette="Bold feature colors")
```

* There is a higher number of people who reside near to offices and hence the attrition levels are lower for distance <10 .With the increase in distance from home,the attrition curve overtakes the no attrition curve which is expected.

## Attrition Vs Business Travel

```{r}
ggplot(attr,aes(BusinessTravel,fill=Attrition))+geom_bar(stat="count",aes(y=..count..),position=position_dodge())+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16),axis.text.x = element_text(angle=90))+labs(x="Travel Frequency",y="Count",title="Attrition Vs Business Travel")
```

* There are more people who travel rarely compared to those who travel frequently.In all the 3 cases,the attrition is not significantly evident.

## Attrition Vs Payrates

It is wise to draw a boxplot to understand the daily wage rate,monthly income  and how it affects the attrition rate.We suspect that those who have been paid less will turnover.

```{r,fig.width=8,fig.height=6}
g1=ggplot(attr,aes(Attrition,DailyRate,fill=Attrition))+geom_boxplot()+theme_few()+theme(plot.title=element_text(hjust=0.5),legend.position="bottom")+scale_y_continuous(limits=c(100,1500),breaks=seq(100,1500,100))+coord_flip()+labs(title="Attrition Vs Daily Wages")
g2=ggplot(attr,aes(Attrition,MonthlyIncome,fill=Attrition))+geom_boxplot()+theme_few()+theme(plot.title=element_text(hjust=0.5),legend.position="bottom")+coord_flip()+labs(title="Attrition Vs Monthly Income")
grid.arrange(g1,g2,nrow=2)

```

There is a difference between the attrition with daily rates.Attrition is present for lesser daily rates and there is no attrition for higher daily rates.The tend is resonating with monthly income too. Let us check with the hourly rates.

```{r}
ggplot(attr,aes(Attrition,HourlyRate,fill=Attrition))+geom_boxplot()+theme_few()+theme(plot.title=element_text(hjust=0.5),legend.position="bottom")+coord_flip()+labs(title="Attrition Vs Hourly Wages")
```

While the difference in the daily wages and the attrition is significant,this is not the case with hourlyrates as seen from the boxplot.

### Percentage of salary hike

```{r}
ggplot(attr,aes(PercentSalaryHike,..count..,fill=Attrition))+geom_histogram(binwidth=5)+theme_few()+theme(plot.title=element_text(hjust=0.5),legend.position="none")+labs(title="Histogram of SalaryHike")+scale_y_continuous(limits=c(0,1500),breaks=seq(0,1500,150))

```

* There are more people who receive 15 % salary hike and while a majority of them stay, about 150 people have left the company.Let us check whether years of experience is a factor considered for percentage of hike.

```{r}
attr %>% ggplot(aes(TotalWorkingYears,PercentSalaryHike,col=factor(Attrition),size=PercentSalaryHike))+geom_point(alpha=0.6)+theme(legend.position="bottom",plot.title = element_text(size=15,hjust=0.5))+labs(title="Percentage of Hike Vs Years of Experience",col="Attrition")
```


* From the graph,we see that there is no linear relationship between totalworkingyears and percentage of salaryhike.
* People with lesser years of work experience have received 25 % of salary hike when they switch over but this pattern is not seen for people with higher work experience.After 20 years,attrition is not seen among people who received 25 % hike.
* As years of experiece increases,those who switch over have actually received less than 20 % hike as the trend indicates.

Let us see whether staying in the company for a long time have actually lead to an higher salary rise.

```{r}
attr %>% ggplot(aes(YearsAtCompany,PercentSalaryHike,size=PercentSalaryHike))+geom_point(color="purple",alpha=0.5)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=16))+labs(title="Years at Company Vs Percentage of Hike")

```

* Here too we see no relation between the two factors.Even People who have lesser year of stint at the company have received maximum hike.


### Which role is paid more?

```{r,fig.width=9}
temp=attr %>% group_by(JobRole) %>% summarise(salary=median(MonthlyIncome)) %>% arrange(desc(salary))
ggplot(temp,aes(factor(JobRole,levels=JobRole),salary))+geom_bar(stat="identity",fill="gold4")+coord_polar()+labs(x="Job Role",y="Median Salary",title="Who gets more??")+theme_few()+theme(axis.text.x=element_text(vjust=300),plot.title=element_text(hjust=0.5,size=16),axis.text.y=element_blank())+scale_x_discrete(labels=function(x)str_wrap(x,width=10))
```

* Manager,Research director,Healthcare representative have higher median salary whereas HR,Sales rep have been paid a lower salary.


## Education,EducationField:

```{r}
temp= attr %>% mutate(Education=factor(Education)) %>% mutate(Education=fct_recode(Education,'Below College'='1','College'='2','Bachelor'='3','Master'='4','Doctor'='5'))
ggplot(temp,aes(Education,fill=Attrition))+geom_bar(stat="count",aes(y=..count..),position=position_dodge())+theme_few()+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16),axis.text.x = element_text(angle=90))+labs(x="Education Level",y="Count",title="Trend of Attrition with Education Level")+scale_fill_canva(palette="Golden afternoon")
```

* There are more people with a bachelors degree followed by masters degree.It is seen that the attrition levels are not pronounced across education levels.Let us include the education field also and make the comparison.

```{r,fig.width=7}
ggplot(temp,aes(Education,fill=Attrition))+geom_bar(stat="count",aes(y=..count..),position=position_dodge())+theme_few()+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16),axis.text.x = element_text(angle=90))+labs(x="Education Level",y="Count",title="Education levels and field of education")+scale_fill_canva(palette="Unique and striking")+facet_grid(~EducationField)
```

* Life sciences,Medical are represented more whereas HR is least represented.

##Education Vs Satisfaction Levels Vs Attrition:

Let us check the satisfaction levels of people with respect to education.Here our assumption is that people with higher education expect greater challenges to work on and if they dont find that this leads to lower satisfaction levels and consequently to attrition.

```{r}
temp %>% mutate(JobSatisfaction=factor(JobSatisfaction)) %>% mutate(JobSatisfaction=fct_recode(JobSatisfaction,"Low"="1","Medium"="2","High"="3","Very High"="4")) %>% ggplot(aes(Education,fill=JobSatisfaction))+geom_bar(stat="count",position = position_dodge())+theme_few()+facet_wrap(~Attrition)+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16),axis.text.x = element_text(angle=90,hjust=0.5))+labs(x="Education",y="Satisfaction Count",title="Comparing attrition with Education")
```

* The satisfaction levels are high as the education levels goes up under "No" attrition category.
* For people who attirit,the satisfaction levels are low as the education level goes up.Hence out assumption is valid.

## Number of companies worked:

```{r}
temp = attr %>% group_by(Attrition,NumCompaniesWorked) %>% tally(sort=TRUE)
ggplot(temp,aes(NumCompaniesWorked,n,fill=Attrition,label=n))+geom_bar(stat="identity",position=position_dodge())+theme_few()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16))+labs(x="Number of Companies",y="Count",title="Number of Companies worked")+coord_cartesian(xlim=c(0,9))+scale_x_continuous(breaks=seq(0,9,1))
```

* There are more people who have changed only 1 company and the attrition level is not pronounced with change in companies.

```{r}
ggplot(attr,aes(TotalWorkingYears,MonthlyIncome,size=NumCompaniesWorked,col=factor(Attrition)))+geom_point(alpha=0.5)+geom_jitter(width=0.04)+theme_few()+theme(plot.title=element_text(hjust=0.5,size=16),legend.position="bottom")+labs(x="Experience",y="MonthlySalary",title="Is switching over advantageous?",col="Attrition")+geom_smooth(method="lm")

```

* From the plot,it is seen that people having less than ~8 years of experience  and have switched over to many companies have experienced a significant hike in the salary levels compared to those who stay in the company.


```{r,fig.height=10,fig.width=8}
g1=ggplot(attr,aes(Attrition,TotalWorkingYears,fill=Attrition))+geom_boxplot()+theme(legend.position="bottom",plot.title=element_text(hjust=0.5))+labs(x="Attrition",y="Years of Experience",title="Attrition trend with number of years of experience")+coord_flip()
g2=attr %>% filter(Attrition=="Yes") %>% ggplot(aes(TotalWorkingYears,..count..))+geom_histogram(binwidth=5,alpha=0.8,fill="#575da9")+labs(x="Years of Experience",y="Count",title="Histogram of Years of experience",subtitle="Attrition=Yes")+theme_few()+theme(plot.title=element_text(hjust=0.5),plot.subtitle=element_text(hjust=0.3))
g3=attr %>% filter(Attrition=="No") %>% ggplot(aes(TotalWorkingYears,..count..))+geom_histogram(binwidth=5,alpha=0.8,fill="#336b87")+labs(x="Years of Experience",y="Count",title="Histogram of Years of experience",subtitle="Attrition=No")+theme_few()+theme(plot.title=element_text(hjust=0.5),plot.subtitle=element_text(hjust=0.3))
grid.arrange(g1,g2,g3,nrow=3)
```

* Boxplot and histogram shows that there is a siginificant difference between the number of experience with attrition levels.
* It is noted that people with less than 10 years of experience prefer to jump to another company whereas after that the jump drops.
* The histgram for both the attrition levels is right skewed.

Let us plot a scatter plot for years of experience vs monthly salary and see the correlation.

```{r}
ggplot(attr,aes(TotalWorkingYears,MonthlyIncome,size=MonthlyIncome,col=factor(Attrition)))+geom_point(alpha=0.4)+theme_few()+theme(plot.title=element_text(hjust=0.5,size=16),legend.position="bottom")+labs(x="Experience",y="MonthlyIncome",title="YearsofExp Vs MonthlyIncome",col="Attrition")+geom_smooth(method="lm")
```

* As expected,there exists a linear relationship between years of experience and monthly income as shown by the line.
* There is a point in the graph,where the lines seems to intersect after which the no attrition line has higher monthly income compared to yes attrition line.

If a person stays in the company then how long he stays in the current role?Lets find out.

```{r,fig.width=13}
ggplot(attr,aes(YearsAtCompany,YearsInCurrentRole,col=factor(JobRole),size=YearsInCurrentRole))+geom_point(alpha=0.5)+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16))+labs(title="Years in Company Vs Role",col="Job Role")
```

* There is a linear relation between the two predictors.

```{r}
ggplot(attr,aes(YearsAtCompany,YearsWithCurrManager,col=factor(Attrition),size=YearsAtCompany))+geom_point(alpha=0.5)+theme(legend.position="bottom",plot.title=element_text(hjust=0.5,size=16))+labs(title="Does working with same manager cause attrition?",col="Attrition")
```

* Though there is a linear relationship and since the data is highly represented by no attrition category,we remain inconclusive with the findings from the plot.

# Attrition Vs Categorical Variables:

Job satisfaction,job involvement,Performance rating,Relationship satisaction are the categorical variables which could have an impact on our response variable.Therefore we analyse these variables with respect to attrition levels.

* Let us first check the job involvement of the respondents.

```{r}
temp= attr %>% mutate(JobInvolvement=factor(JobInvolvement)) %>% mutate(JobInvolvement=fct_recode(JobInvolvement,"Low"="1","Medium"="2","High"="3","Very High"="4"))
round((prop.table(table(temp$JobInvolvement)))*100,2)
```

* 59 % have high job involvement whereas 25 % have medium involvement in the job.Let us check how this relates to attrition.

```{r,fig.height=5}
ggplot(temp,aes(x=JobInvolvement,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="Job Involvement",y="Percentage",title="Job Involvement Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* People with **high** job involvement have higher attrition rates followed by **medium** involvement people.But,equal number of percentage of people have also shown no attrition rates.

## Job Satisfaction


```{r}
temp = attr %>% mutate(JobSatisfaction=factor(JobSatisfaction)) %>% mutate(JobSatisfaction=fct_recode(JobSatisfaction,"Low"="1","Medium"="2","High"="3","Very High"="4"))
```

```{r,fig.height=5}
ggplot(temp,aes(x=JobSatisfaction,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="Job Satisfaction",y="Percentage",title="Job Satisfaction Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* As expected,people with low satisfaction have left the company (28 %) in large number .What is surprising is ,out of those who leave about 30.8 %  have experience high job satisfaction.Therefore,there should be some other factor which triggers their exit from the present company.
* There is a visible trend in the category of people who do not leave whereas this is not so in the case of people who leave.The attrition group is most represented by people having high and very high job satisfaction.

## Performance Rating:

```{r}
temp= attr %>% mutate(PerformanceRating=factor(PerformanceRating)) %>% mutate(PerformanceRating=fct_recode(PerformanceRating,"Low"="1","Good"="2","Excellent"="3","Outstanding"="4"))
ggplot(temp,aes(x=PerformanceRating,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="PerformanceRating",y="Percentage",title="Performance Rating Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* Though there are 4 levels in performance rating,our dataset is represented only by 2 levels-Excellent and Outstanding.It may be seen that there is no difference between the performance rating and attrition levels.Both the groups have shown similar percentages.

## Relationship Satisfaction:

```{r}
temp= attr %>% mutate(RelationshipSatisfaction=factor(RelationshipSatisfaction)) %>% mutate(RelationshipSatisfaction=fct_recode(RelationshipSatisfaction,"Low"="1","Medium"="2","High"="3","Very High"="4"))
ggplot(temp,aes(x=RelationshipSatisfaction,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="RelationshipSatisfaction",y="Percentage",title="RelationshipSatisfaction Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```


* In this too,we find that almost 57 % (combining high and very high) experience attrition whereas similar percentage have also stayed within the company.

## Worklife balance:

```{r}
temp= attr %>% mutate(WorkLifeBalance=factor(WorkLifeBalance)) %>% mutate(WorkLifeBalance=fct_recode(WorkLifeBalance,"Bad"="1","Good"="2","Better"="3","Best"="4"))
ggplot(temp,aes(x=WorkLifeBalance,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="WorkLifeBalance",y="Percentage",title="Worklifebalance Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* As seen with the other categorical variables,here too we find that people having better work life balance leave the company whereas about 60 % who have experienced better work life balance stay with the company.We now continue with our last categorical variable-Environment satisfaction.

## Environment Satisfaction:

```{r}
temp= attr %>% mutate(EnvironmentSatisfaction=factor(EnvironmentSatisfaction)) %>% mutate(EnvironmentSatisfaction=fct_recode(EnvironmentSatisfaction,"Low"="1","Medium"="2","High"="3","Very High"="4"))
ggplot(temp,aes(x=EnvironmentSatisfaction,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="EnvironmentSatisfaction",y="Percentage",title="Environment satisfaction Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* Here we see that people having low environment satisfaction ( 30.4%) leave the company.

## Attrition Vs OverTime:

```{r}
ggplot(attr,aes(x=OverTime,group=Attrition))+geom_bar(stat="count",aes(y=..prop..,fill=factor(..x..)))+labs(x="Overtime",y="Percentage",title="Overtime Vs Attrition Rates")+facet_wrap(~Attrition)+theme_few()+theme(legend.position="none",plot.title=element_text(hjust=0.5,size=14))+geom_text(aes(label=scales::percent(..prop..),y=..prop..),stat="count",vjust=-0.5)
```

* 53 % of those who experience attrition have worked overtime whereas 76 % of those who have not experienced overtime have not left the company.Therefore overtime is a strong indicator of attrition.

# Modelling 

## Split data into train and test:

We partition the data into train and test set.

```{r}
set.seed(1000)
a=createDataPartition(attr$Attrition,p=0.7,list=FALSE)
train=attr[a,]
test=attr[-a,]
cat("Train data has",nrow(train),"observations")
cat("Test data has",nrow(test),"observations")
train=train %>% mutate(Attrition=factor(Attrition)) %>% mutate(Attrition=fct_recode(Attrition,"0"="No","1"="Yes"))
test=test %>% mutate(Attrition=factor(Attrition)) %>% mutate(Attrition=fct_recode(Attrition,"0"="No","1"="Yes"))
#scale the data:
num=list(names(numeric))
train.num=scale(train[,names(train) %in% num[[1]]])
train.scale=cbind(train[,!names(train) %in% num[[1]]],train.num)
test.num=scale(test[,names(test) %in% num[[1]]])
test.scale=cbind(test[,!names(test) %in% num[[1]]],test.num)

```


## CART Model:

We have already split the data into train and test.The split ratio is 70:30.We model the train data using CART model.We have subset the data to include only those variables likely to be a good predictor of the turnover.

This is a class imbalance problem and hence we have use **SMOTE** method of sampling for balancing the class.



```{r}
#str(train)
factor.col=c("BusinessTravel","EnvironmentSatisfaction","Gender","JobInvolvement","JobLevel","JobSatisfaction","MaritalStatus","OverTime","PerformanceRating","RelationshipSatisfaction","WorkLifeBalance","Department","EducationField","JobRole")
train.scale[factor.col]=lapply(train.scale[factor.col],factor)
test.scale[factor.col]=lapply(test.scale[factor.col],factor)
p=prop.table(table(train.scale$Attrition))
cat("Before SMOTE the propotions are:"); print(p,row.names=FALSE)
set.seed(1000)
smote_train=SMOTE(Attrition ~ .,data=train.scale)
q=prop.table(table(smote_train$Attrition))
cat("After SMOTE the propotions are:"); print(q,row.names=FALSE)

```

For feature selection,we use the boruta method to generate the variable importance table.

```{r}
set.seed(1000)
boruta_output=Boruta(Attrition~.,data=smote_train,doTrace=2)
#boruta_signif <- names(boruta_output$finalDecision[boruta_output$finalDecision %in% c("Confirmed", "Tentative")])
print(boruta_output)
plot(boruta_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")
```

The importance values are shown below:Here I have used the boruta method.There are also other libraries like [LIME(Local Interpretable Model-Agnostic Explanations)](https://cran.r-project.org/web/packages/lime/README.html) which can be applied.

```{r}
cat("Attributes deemed important:",getSelectedAttributes(boruta_output,withTentative = FALSE),sep="\n")
#boruta.df=attStats(boruta_output)
#boruta.df=boruta.df %>% tibble::rownames_to_column("Attribute Name") %>% arrange(desc(maxImp))
#data.table::data.table(boruta.df)
```

From the importance table,we see that we need to include all the variables for our modelling.


Now we do the modelling on the train data.


```{r}
set.seed(1000)
r.control=rpart.control(minsplit=60,minbucket =20,cp=0,xval=10)
cart.train=rpart(Attrition~.,data=smote_train,method="class",control=r.control)
cmt=table(Predicted=predict(cart.train,smote_train,type="class"),Actual=smote_train$Attrition)
confusionMatrix(cmt,positive="1",mode="prec_recall")
```

The confusion matrix shows that the model has predicted 801 out of 996 actual turnover instances correctly.Lets use this over the test data.

```{r}
cart.test=predict(cart.train,newdata=test.scale,type="class")
prob=predict(cart.train,test.scale,type="prob")
cmtest=table(Prediction=cart.test,Actual=test.scale$Attrition)
confusionMatrix(cmtest,positive="1",mode="everything")
pred_cart=ROCR::prediction(prob[,2],test.scale$Attrition)
perf_cart=performance(pred_cart,"auc")
perf_cart=round(as.numeric(perf_cart@y.values),3)
cat("The AUC Value is",perf_cart)
```


While the model performs well on the train data,when tested on the test data the model prediction is rather modest.Out of the 142 samples,the model has predicted 94 instances correctly.The AUC value is 
0.761.



## Neural Network 

Using H2o library  on the same dataset for predictions we have the performance metrix for train data as

```{r}
y='Attrition'
x=setdiff(names(train.scale),y)
h2o.init(nthreads=-1)
model=h2o.deeplearning(x,y,training_frame = as.h2o(train.scale),activation = "Rectifier",hidden=6,epochs = 100,train_samples_per_iteration = -2,nfolds=2,seed=1,keep_cross_validation_predictions = TRUE)
y_pred=h2o.predict(model,newdata=as.h2o(test.scale[,!names(test.scale) %in% "Attrition"]))
y_pred=(y_pred > 0.5)
y_pred=as.data.frame(y_pred)
```


The model performance measures are summarised as follows,

```{r}
h2o.performance(model)

```


From the data it is seen that the AUC is 0.969 and the error rate of predicting the attrition level is 0.18.Now testing it over the test data and finding out the model performance measures we have,


```{r}
h2o.performance(model,newdata=as.h2o(test.scale))
```


The model performance is robust with an error rate of 21 % predicting 112 out of 142 instances correctly.The AUC value is 0.879.

